// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// LEVEL 1 & 2: Organizations (QRDisplay + Client Brands)
model Organization {
  id        String   @id @default(cuid())
  orgId     String   @unique
  name      String
  slug      String   @unique
  type      String   // 'platform' (QRDisplay) or 'client' (brands)
  
  // Public Support Settings
  logoUrl           String?
  supportEmail      String?
  supportPhone      String?
  emailFromName     String?
  emailFromAddress  String?
  emailReplyTo      String?
  websiteUrl        String?
  
  // Customer Service Contact Info
  customerServiceEmail String?
  customerServicePhone String?
  
  subscriptionStatus String?
  subscriptionPlan   String?
  stripeCustomerId   String?
  
  // Shopify Integration (multi-tenant)
  shopifyStoreName     String?   // e.g., "vitadreamz.myshopify.com"
  shopifyAccessToken   String?   // Encrypted access token
  shopifyApiKey        String?   // Encrypted (for private apps)
  shopifyApiSecret     String?   // Encrypted (for private apps)
  shopifyWebhookSecret String?   // For webhook signature verification
  shopifyConnectedAt   DateTime? // When Shopify was connected
  shopifyActive        Boolean   @default(false) // Is integration active?
  
  // Commission Settings (per-brand)
  commissionRate       Float?    @default(10.0) // Percentage (e.g., 10.0 = 10%)
  attributionWindow    Int?      @default(30)   // Days to attribute sale to store
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users     User[]
  stores    Store[]
  displays  Display[]
  packs     DisplayPack[]
  orders    Order[]
  customers Customer[]
  promoRedemptions PromoRedemption[]
  conversions Conversion[]
  webhookLogs ShopifyWebhookLog[]
  
  @@map("organizations")
}

// Users (all levels)
model User {
  id       String   @id @default(cuid())
  userId   String   @unique
  orgId    String
  email    String   @unique
  name     String?
  phone    String?
  role     String   // 'super-admin', 'org-admin', 'store-admin'
  storeId  String?
  
  createdAt DateTime @default(now())
  
  organization Organization @relation(fields: [orgId], references: [orgId])
  store        Store?       @relation(fields: [storeId], references: [storeId])
  
  @@map("users")
}

// LEVEL 3: Stores
model Store {
  id           String   @id @default(cuid())
  storeId      String   @unique
  orgId        String
  
  status       String   @default("active")
  storeName    String
  
  // Owner (business owner/main decision maker)
  ownerName         String?
  ownerPhone        String?
  ownerEmail        String?
  
  // Program Administrator (day-to-day manager, receives notifications)
  adminName         String?
  adminEmail        String?
  adminPhone        String?
  
  // Purchasing Manager (handles inventory ordering)
  purchasingManager String?
  purchasingPhone   String?
  purchasingEmail   String?
  
  // Shopify wholesale account linkage
  shopifyCustomerId String?  // Links this store to a Shopify customer for commission credits
  parentAccountName String?  // For multi-location: "Acme Corp" (shown in UI)
  
  // Subscription & Billing (Store pays Organization via Recharge)
  subscriptionTier        String    @default("free") // free, basic, dreamer, mega
  subscriptionStatus      String    @default("active") // active, past_due, canceled, trialing
  rechargeCustomerId      String? // Customer ID in org's Recharge account
  rechargeSubscriptionId  String? // Subscription ID in org's Recharge account
  nextBillingDate         DateTime?
  trialEndsAt             DateTime?
  
  // Subscription Benefits (accumulate with each billing cycle)
  customerSlotsGranted    Int       @default(10) // Total customer slots granted (accumulates each billing)
  samplesPerQuarter       Int       @default(10)
  commissionRate          Float     @default(5.0) // Percentage
  promoReimbursementRate  Float     @default(10.0) // Percentage of promo value as store credit
  
  // Sales Rep Assignment
  salesRepName  String?
  salesRepEmail String?
  salesRepPhone String?
  
  streetAddress String?
  address2      String?  // Suite, unit, apt number
  city          String?
  state         String?
  zipCode       String?
  
  timezone     String   @default("America/Los_Angeles")
  promoOffer   String   @default("20%-off 1st Purchase")
  returningCustomerPromo String @default("10%-off In-Store Purchase")
  followupDays Int[]    @default([4, 12])
  postPurchaseFollowupDays Int[] @default([45, 90])
  staffPin     String?

  // Wizard setup photo (if uploaded during setup)
  setupPhotoUrl         String?
  setupPhotoUploadedAt  DateTime?
  setupPhotoCredit      Boolean   @default(false)
  
  // Store Credit (QRDisplay-managed)
  storeCredit           Decimal   @default(0.00) @db.Decimal(10, 2)
  
  // Available sample products (stores choose which samples they carry)
  availableSamples String[] @default([])
  
  // Available products for purchase (SKUs that this store carries)
  availableProducts String[] @default([])
  
  activatedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  organization Organization @relation(fields: [orgId], references: [orgId])
  displays     Display[]
  customers    Customer[]
  users        User[]
  staff        Staff[]
  promoRedemptions PromoRedemption[]
  conversions  Conversion[]
  creditTransactions StoreCreditTransaction[]
  inventory    StoreInventory[]
  inventoryTransactions InventoryTransaction[]
  productHolds ProductHold[]
  
  @@map("stores")
}

// Store Inventory Tracking
model StoreInventory {
  id              String   @id @default(cuid())
  storeId         String
  productSku      String
  
  quantityOnHand     Int      @default(0)  // Physical inventory in store
  quantityIncoming   Int      @default(0)  // Ordered but not yet received
  quantityReserved   Int      @default(0)  // Reserved for customer holds (24hr)
  quantityAvailable  Int      @default(0)  // onHand - reserved (computed)
  
  lowStockThreshold  Int      @default(10) // Alert when onHand falls below this
  
  lastRestocked   DateTime?
  updatedAt       DateTime @updatedAt
  
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productSku], references: [sku])
  incomingOrders IncomingInventoryOrder[]
  
  @@unique([storeId, productSku])
  @@index([storeId])
  @@index([quantityOnHand]) // For low stock queries
  @@map("store_inventory")
}

// Inventory Transaction Log
model InventoryTransaction {
  id          String   @id @default(cuid())
  storeId     String
  productSku  String
  
  type        String   // "restock", "wholesale_ordered", "wholesale_shipped", "wholesale_received", "sample_redemption", "promo_sale", "hold_created", "hold_released", "hold_expired", "manual_adjustment"
  quantity    Int      // Positive for incoming, negative for outgoing
  
  customerId  String?  // If related to a customer action
  staffId     String?  // If processed by staff
  notes       String?
  
  balanceAfter Int     // Inventory balance after this transaction
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // For holds that auto-expire
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@index([storeId, createdAt])
  @@index([expiresAt]) // For finding expired holds
  @@index([productSku])
  @@index([type])
  @@map("inventory_transactions")
}

// Product Holds (24-hour pickup reservations)
model ProductHold {
  id          String   @id @default(cuid())
  storeId     String
  customerId  String
  productSku  String
  
  quantity    Int      @default(1)
  status      String   @default("active") // active, picked_up, expired, cancelled
  
  createdAt   DateTime @default(now())
  expiresAt   DateTime // 24 hours from creation
  notifiedAt  DateTime? // When store was notified
  pickedUpAt  DateTime?
  
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([storeId, status])
  @@index([expiresAt])
  @@index([customerId])
  @@map("product_holds")
}

// Incoming Inventory Orders (Wholesale orders in transit)
model IncomingInventoryOrder {
  id                String   @id @default(cuid())
  storeId           String
  productSku        String
  storeInventoryId  String
  
  shopifyOrderId    String   // Shopify order ID
  shopifyOrderNumber String  // Human-readable #1234
  
  quantityOrdered   Int      // Number of units ordered
  quantityReceived  Int @default(0) // Number actually received
  
  status            String @default("ordered") // ordered, paid, shipped, in_transit, delivered, received, cancelled
  
  // Tracking information
  trackingNumber    String?
  carrier           String?
  trackingUrl       String?
  
  // Timeline
  orderedAt         DateTime
  paidAt            DateTime?
  shippedAt         DateTime?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  receivedAt        DateTime? // When store marks as received in system
  
  // Webhook data
  shopifyFulfillmentId String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  storeInventory StoreInventory @relation(fields: [storeInventoryId], references: [id], onDelete: Cascade)
  
  @@index([storeId])
  @@index([shopifyOrderId])
  @@index([status])
  @@index([storeInventoryId])
  @@map("incoming_inventory_orders")
}

// Store Credit Transactions
model StoreCreditTransaction {
  id        String   @id @default(cuid())
  storeId   String
  
  amount    Decimal  @db.Decimal(10, 2) // Positive for credits, negative for redemptions
  type      String   // 'earned' (setup photo, etc) or 'redeemed' (used in order)
  reason    String   // 'Setup Photo Upload', 'Wholesale Order Applied', etc.
  
  // Optional reference to related entities
  displayId String?  // If earned via display setup
  orderId   String?  // If redeemed in an order
  
  balance   Decimal  @db.Decimal(10, 2) // Store's balance after this transaction
  
  createdAt DateTime @default(now())
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@index([storeId])
  @@index([createdAt])
  @@map("store_credit_transactions")
}

// Display Packs (boxes of 10 displays)
model DisplayPack {
  id          String   @id @default(cuid())
  packId      String   @unique
  
  displayIds  String[]
  quantity    Int
  
  status      String   @default("inventory") // inventory, shipped, activated
  orderId     String?
  assignedOrgId String?
  
  qrCodeUrl   String?
  
  shippedAt   DateTime?
  activatedAt DateTime?
  activatedBy String?
  
  createdAt   DateTime @default(now())
  
  organization Organization? @relation(fields: [assignedOrgId], references: [orgId])
  order        Order?         @relation(fields: [orderId], references: [orderId])
  
  @@map("display_packs")
}

// Individual Displays
model Display {
  id          String   @id @default(cuid())
  displayId   String   @unique
  
  ownerOrgId    String  @default("ORG-QRDISPLAY")
  assignedOrgId String?
  storeId       String?
  packId        String?
  
  shortlink   String?  @unique
  targetUrl   String?
  prefillUrl  String?
  qrPngUrl    String?
  
  status      String   @default("inventory")
  
  orderId     String?
  shippedAt   DateTime?
  activatedAt DateTime?
  activatedBy String?
  
  createdAt   DateTime @default(now())

  // Wizard setup photo (if uploaded during setup)
  setupPhotoUrl         String?
  setupPhotoUploadedAt  DateTime?
  setupPhotoCredit      Boolean   @default(false)
  
  organization Organization? @relation(fields: [assignedOrgId], references: [id])
  store        Store?         @relation(fields: [storeId], references: [storeId])
  order        Order?         @relation(fields: [orderId], references: [orderId])
  
  @@map("displays")
}

// Orders
model Order {
  id            String   @id @default(cuid())
  orderId       String   @unique
  orgId         String
  
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  
  status        String   @default("pending")
  
  trackingNumber String?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  createdAt     DateTime @default(now())
  
  organization  Organization @relation(fields: [orgId], references: [id])
  displays      Display[]
  packs         DisplayPack[]
  
  @@map("orders")
}

// Customers
model Customer {
  id           String    @id @default(cuid())
  memberId     String    @unique
  orgId        String
  storeId      String
  
  firstName    String
  lastName     String
  phone        String
  email        String?
  sampleChoice String
  
  activated    Boolean   @default(false)
  activatedAt  DateTime?
  redeemed     Boolean   @default(false)
  redeemedAt   DateTime?
  redeemedBy   String?
  
  // Staff tracking
  redeemedByStaffId      String?
  promoRedeemedByStaffId String?
  
  promoSlug        String?
  promoRedeemed    Boolean   @default(false)
  promoRedeemedAt  DateTime?
  
  // Returning customer promo (generated after first purchase)
  returningPromoSlug String?
  
  // Lifecycle stage tracking
  currentStage     String    @default("pending") // pending, redeemed, purchased, repeat
  stageChangedAt   DateTime  @default(now())
  
  // Shopify Integration
  shopifyCustomerId String?   // Shopify customer ID for attribution
  syncedToShopify   Boolean   @default(false)
  syncedAt          DateTime?
  attributedStoreId String?   // Store that gets credit for conversions
  sampleDate        DateTime? // When they got their sample (for attribution window)
  
  requestedAt  DateTime  @default(now())
  
  organization Organization @relation(fields: [orgId], references: [id])
  store        Store        @relation(fields: [storeId], references: [storeId])
  redeemedByStaff      Staff?  @relation("RedeemedByStaff", fields: [redeemedByStaffId], references: [id], onDelete: SetNull)
  promoRedeemedByStaff Staff?  @relation("PromoRedeemedByStaff", fields: [promoRedeemedByStaffId], references: [id], onDelete: SetNull)
  promoRedemptions PromoRedemption[]
  purchaseIntents  PurchaseIntent[]
  conversions      Conversion[]
  webhookLogs      ShopifyWebhookLog[]
  productHolds     ProductHold[]
  staffPointTransactions StaffPointTransaction[]
  
  @@index([shopifyCustomerId])
  @@map("customers")
}

// Staff Members
model Staff {
  id                String   @id @default(cuid())
  staffId           String   @unique
  storeId           String
  
  // Basic Info
  firstName         String
  lastName          String
  email             String?
  phone             String
  profilePhoto      String?
  
  // Work Details
  type              String   // Sales, Marketing, Cashier, Manager
  staffPin          String   // 4-digit PIN for redemptions
  status            String   @default("active") // active, inactive, pending
  hireDate          DateTime @default(now())
  
  // Schedule
  onCallDays        String[] // ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
  onCallHoursStart  String   // "09:00"
  onCallHoursStop   String   // "17:00"
  
  // Performance Metrics (cached for leaderboard performance)
  samplesRedeemed   Int      @default(0)
  salesGenerated    Int      @default(0)
  lastActive        DateTime?
  
  // Gamification Points
  totalPoints       Int      @default(0) // Lifetime points earned
  quarterlyPoints   Int      @default(0) // Points this quarter (resets every 3 months)
  lastQuarterReset  DateTime? // When quarterly points were last reset

  // Verification
  verified            Boolean   @default(false)
  verificationToken   String?   @unique
  verificationExpiry  DateTime?
  verifiedAt          DateTime?
  
  // Metadata
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  store                Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customerRedemptions  Customer[] @relation("RedeemedByStaff")
  promoRedemptions     Customer[] @relation("PromoRedeemedByStaff")
  purchaseIntents      PurchaseIntent[]
  pointTransactions    StaffPointTransaction[]
  
  @@map("staff")
}

// Shortlinks
model Shortlink {
  id         String    @id @default(cuid())
  slug       String    @unique
  action     String
  storeId    String
  memberId   String?
  role       String
  
  requiresPin Boolean  @default(false)
  redeemed    Boolean  @default(false)
  redeemedAt  DateTime?
  
  createdAt   DateTime @default(now())
  usedAt      DateTime?
  
  @@map("shortlinks")
}

// Products (SKUs that brands sell)
model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  orgId       String   // Which brand owns this product
  
  name        String
  description String?
  category    String?
  
  // Product type: retail (individual units) or wholesale-box (bulk boxes)
  productType String   @default("retail")
  
  price       Decimal  @db.Decimal(10, 2)
  msrp        Decimal? @db.Decimal(10, 2)
  
  // Wholesale box fields (only for productType = 'wholesale-box')
  unitsPerBox     Int?     // Number of units in a box
  wholesalePrice  Decimal? @db.Decimal(10, 2) // Price per unit (wholesale)
  retailPrice     Decimal? @db.Decimal(10, 2) // Price per unit (retail)
  
  // Shopify integration
  shopifyProductId String? // Shopify product ID (e.g., "gid://shopify/Product/1234567890")
  shopifyVariantId String? // Shopify variant ID (e.g., "gid://shopify/ProductVariant/1234567890")
  
  imageUrl    String?
  
  // Status flags
  active      Boolean  @default(true)
  featured    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  purchaseIntents PurchaseIntent[]
  storeInventory  StoreInventory[]
  
  @@map("products")
}

// Purchase Intents (customer selects product, store fulfills)
model PurchaseIntent {
  id          String   @id @default(cuid())
  
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  
  storeId     String
  
  productSku  String
  product     Product  @relation(fields: [productSku], references: [sku])
  
  // Pricing at time of intent
  originalPrice  Decimal  @db.Decimal(10, 2)
  discountPercent Int     // e.g., 20 for 20% off
  finalPrice     Decimal  @db.Decimal(10, 2)
  
  // Status tracking
  status      String   @default("pending") // pending, fulfilled, cancelled
  
  // Verify link for in-store redemption
  verifySlug  String   @unique
  
  fulfilledAt DateTime?
    fulfilledByStaffId String?  // Staff ID who completed the sale
    fulfilledByStaff   Staff?   @relation(fields: [fulfilledByStaffId], references: [id], onDelete: SetNull)
  
    // When store notifies customer that order is ready
    notifiedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([customerId])
  @@index([storeId])
  @@index([productSku])
  
  @@map("purchase_intents")
}

// Promo Redemptions
model PromoRedemption {
  id            String    @id @default(cuid())
  
  customerId    String
  customer      Customer  @relation(fields: [customerId], references: [id])
  
  storeId       String
  store         Store     @relation(fields: [storeId], references: [id])
  
  orgId         String
  organization  Organization @relation(fields: [orgId], references: [id])
  
  promoOffer    String
  promoSlug     String    @unique
  
  redeemedAt    DateTime?
  redeemedBy    String?
  redeemedByStaffId String?
  
  purchaseAmount Decimal?  @db.Decimal(10, 2)
  discountAmount Decimal?  @db.Decimal(10, 2)
  
  createdAt     DateTime  @default(now())
  
  @@index([customerId])
  @@index([storeId])
  @@index([orgId])
  
  @@map("promo_redemptions")
}

// Message Log
model MessageLog {
  id           String   @id @default(cuid())
  timestamp    DateTime @default(now())
  type         String
  templateKey  String?
  toAddress    String
  status       String
  sidOrReason  String?
  storeId      String?
  memberId     String?
  context      Json?
  body         String?
  
  @@map("message_log")
}

// Opt Outs
model OptOut {
  id        String   @id @default(cuid())
  phone     String   @unique
  timestamp DateTime @default(now())
  reason    String?
  
  @@map("opt_outs")
}

// Errors
model Error {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  whereError String
  meta       Json?
  userInfo   String?
  
  @@map("errors")
}

// Shopify Integration Models

// Tracks conversions from samples to Shopify purchases
model Conversion {
  id                String   @id @default(cuid())
  orgId             String
  customerId        String   // QRDisplay customer
  shopifyOrderId    String   // Shopify order ID
  shopifyCustomerId String   // Shopify customer ID
  storeId           String   // Store that gets credit
  
  orderNumber       String   // Human-readable order number
  orderTotal        Float    // Total order amount
  commissionAmount  Float    // Commission earned by store
  commissionRate    Float    // Rate used for calculation
  
  sampleDate        DateTime // When customer got sample
  purchaseDate      DateTime // When they purchased
  daysToConversion  Int      // Days between sample and purchase
  
  attributed        Boolean  @default(true) // Within attribution window?
  paid              Boolean  @default(false) // Commission paid to store?
  
  createdAt         DateTime @default(now())
  
  organization Organization @relation(fields: [orgId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [memberId])
  store        Store        @relation(fields: [storeId], references: [storeId])
  
  @@index([orgId])
  @@index([customerId])
  @@index([storeId])
  @@index([shopifyOrderId])
  @@map("conversions")
}

// Logs all Shopify webhook events
model ShopifyWebhookLog {
  id            String   @id @default(cuid())
  orgId         String
  customerId    String?  // QRDisplay customer ID if found
  webhookId     String?  // Shopify webhook ID
  topic         String   // e.g., "orders/paid"
  shopifyOrderId String?
  
  payload       Json     // Full webhook payload
  status        String   @default("pending") // pending, processed, failed, ignored
  errorMessage  String?
  
  processedAt   DateTime?
  createdAt     DateTime @default(now())
  
  organization Organization @relation(fields: [orgId], references: [id])
  customer     Customer?    @relation(fields: [customerId], references: [id])
  
  @@index([orgId])
  @@index([customerId])
  @@index([shopifyOrderId])
  @@index([status])
  @@map("shopify_webhook_logs")
}

// Staff Point Transactions for Gamification
model StaffPointTransaction {
  id          String   @id @default(cuid())
  staffId     String
  storeId     String
  orgId       String
  
  points      Decimal  @db.Decimal(10, 2) // Allow half points (0.5, 1.0, 2.0, etc)
  type        String   // 'sample', 'online_sale', 'instore_sale', 'manual_adjustment'
  reason      String   // Detailed description
  
  // References to what triggered the points
  customerId  String?  // If related to a customer
  conversionId String? // If from online sale
  purchaseIntentId String? // If from in-store sale
  
  // Quarter tracking for competitions
  quarter     String   // "2025-Q1", "2025-Q2", etc
  
  createdAt   DateTime @default(now())
  
  // Relations
  staff        Staff        @relation(fields: [staffId], references: [id], onDelete: Cascade)
  customer     Customer?    @relation(fields: [customerId], references: [id])
  
  @@index([staffId])
  @@index([storeId])
  @@index([orgId])
  @@index([quarter])
  @@index([type])
  @@map("staff_point_transactions")
}

// Magic Links for Store Auth
model MagicLink {
  id        String   @id @default(cuid())
  token     String   @unique
  storeId   String
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@map("magic_links")
}


