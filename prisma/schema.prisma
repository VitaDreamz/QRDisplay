generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model conversions {
  id                String        @id
  orgId             String
  customerId        String
  shopifyOrderId    String
  shopifyCustomerId String
  storeId           String
  orderNumber       String
  orderTotal        Float
  commissionAmount  Float
  commissionRate    Float
  sampleDate        DateTime
  purchaseDate      DateTime
  daysToConversion  Int
  attributed        Boolean       @default(true)
  paid              Boolean       @default(false)
  createdAt         DateTime      @default(now())
  customers         customers     @relation(fields: [customerId], references: [memberId])
  organizations     organizations @relation(fields: [orgId], references: [orgId])
  stores            stores        @relation(fields: [storeId], references: [storeId])

  @@index([customerId])
  @@index([orgId])
  @@index([shopifyOrderId])
  @@index([storeId])
}

model customers {
  id                                            String                     @id
  memberId                                      String                     @unique
  orgId                                         String
  storeId                                       String
  firstName                                     String
  lastName                                      String
  phone                                         String
  email                                         String?
  sampleChoice                                  String
  activated                                     Boolean                    @default(false)
  activatedAt                                   DateTime?
  redeemed                                      Boolean                    @default(false)
  redeemedAt                                    DateTime?
  redeemedBy                                    String?
  requestedAt                                   DateTime                   @default(now())
  promoRedeemed                                 Boolean                    @default(false)
  promoRedeemedAt                               DateTime?
  promoSlug                                     String?
  promoRedeemedByStaffId                        String?
  redeemedByStaffId                             String?
  currentStage                                  String                     @default("pending")
  stageChangedAt                                DateTime                   @default(now())
  attributedStoreId                             String?
  sampleDate                                    DateTime?
  shopifyCustomerId                             String?
  syncedAt                                      DateTime?
  syncedToShopify                               Boolean                    @default(false)
  lastSampleDate                                DateTime?
  returningPromoSlug                            String?
  smsOptedOut                                   Boolean?                   @default(false)
  followupSent                                  Boolean?                   @default(false)
  lastContactedAt                               DateTime?                  @db.Timestamp(6)
  notes                                         String?
  source                                        String?                    @default("in-store")
  status                                        String?                    @default("active")
  conversions                                   conversions[]
  organizations                                 organizations              @relation(fields: [orgId], references: [orgId])
  staff_customers_promoRedeemedByStaffIdTostaff staff?                     @relation("customers_promoRedeemedByStaffIdTostaff", fields: [promoRedeemedByStaffId], references: [id])
  staff_customers_redeemedByStaffIdTostaff      staff?                     @relation("customers_redeemedByStaffIdTostaff", fields: [redeemedByStaffId], references: [id])
  stores                                        stores                     @relation(fields: [storeId], references: [storeId])
  promo_redemptions                             promo_redemptions[]
  purchase_intents                              purchase_intents[]
  shopify_webhook_logs                          shopify_webhook_logs[]
  staff_point_transactions                      staff_point_transactions[]

  @@index([shopifyCustomerId])
}

model display_packs {
  id            String         @id
  packId        String         @unique
  displayIds    String[]
  quantity      Int
  status        String         @default("inventory")
  orderId       String?
  assignedOrgId String?
  qrCodeUrl     String?
  shippedAt     DateTime?
  activatedAt   DateTime?
  activatedBy   String?
  createdAt     DateTime       @default(now())
  organizations organizations? @relation(fields: [assignedOrgId], references: [orgId])
  orders        orders?        @relation(fields: [orderId], references: [orderId])
}

model displays {
  id                   String         @id
  displayId            String         @unique
  ownerOrgId           String         @default("ORG-QRDISPLAY")
  assignedOrgId        String?
  storeId              String?
  packId               String?
  shortlink            String?        @unique
  targetUrl            String?
  prefillUrl           String?
  qrPngUrl             String?
  status               String         @default("inventory")
  orderId              String?
  shippedAt            DateTime?
  activatedAt          DateTime?
  activatedBy          String?
  createdAt            DateTime       @default(now())
  setupPhotoCredit     Boolean        @default(false)
  setupPhotoUploadedAt DateTime?
  setupPhotoUrl        String?
  organizations        organizations? @relation(fields: [assignedOrgId], references: [orgId])
  orders               orders?        @relation(fields: [orderId], references: [orderId])
  stores               stores?        @relation(fields: [storeId], references: [storeId])
}

model errors {
  id         String   @id
  timestamp  DateTime @default(now())
  whereError String
  meta       Json?
  userInfo   String?
}

model inventory_transactions {
  id               String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId          String
  productSku       String
  type             String
  quantity         Int
  previousQuantity Int?
  newQuantity      Int?
  reason           String?
  notes            String?
  performedBy      String?
  createdAt        DateTime @default(now())
  balanceAfter     Int?
  customerId       String?
  stores           stores   @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model label_print_history {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  batchId    String   @unique
  printedAt  DateTime @default(now())
  printedBy  String?
  displayIds String[]
  labelCount Int?
  sheets     Int
  createdAt  DateTime @default(now())
  quantity   Int?

  @@index([batchId])
  @@index([printedAt])
}

model magic_links {
  id        String    @id
  token     String    @unique
  storeId   String
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}

model message_campaigns {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId        String
  name           String
  message        String
  status         String    @default("draft")
  scheduledFor   DateTime?
  sentAt         DateTime?
  recipientCount Int?      @default(0)
  successCount   Int?      @default(0)
  failureCount   Int?      @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now())
  audience       String    @default("all")
  stores         stores    @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model message_log {
  id          String   @id
  timestamp   DateTime @default(now())
  type        String
  templateKey String?
  toAddress   String
  status      String
  sidOrReason String?
  storeId     String?
  memberId    String?
  context     Json?
  body        String?
}

model opt_outs {
  id        String   @id
  phone     String   @unique
  timestamp DateTime @default(now())
  reason    String?
}

model orders {
  id             String          @id
  orderId        String          @unique
  orgId          String
  quantity       Int
  unitPrice      Float
  totalPrice     Float
  status         String          @default("pending")
  trackingNumber String?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime        @default(now())
  display_packs  display_packs[]
  displays       displays[]
  organizations  organizations   @relation(fields: [orgId], references: [orgId])
}

model organizations {
  id                       String                     @id
  orgId                    String                     @unique
  name                     String
  slug                     String                     @unique
  type                     String
  subscriptionStatus       String?
  subscriptionPlan         String?
  stripeCustomerId         String?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  emailFromAddress         String?
  emailFromName            String?
  emailReplyTo             String?
  supportEmail             String?
  supportPhone             String?
  websiteUrl               String?
  logoUrl                  String?
  attributionWindow        Int?                       @default(30)
  commissionRate           Float?                     @default(10.0)
  shopifyAccessToken       String?
  shopifyActive            Boolean                    @default(false)
  shopifyApiKey            String?
  shopifyApiSecret         String?
  shopifyConnectedAt       DateTime?
  shopifyStoreName         String?
  shopifyWebhookSecret     String?
  brandTier                String?                    @default("free")
  brandStatus              String?                    @default("pending")
  maxStoresPerMonth        Int?                       @default(5)
  maxSampleProducts        Int?                       @default(1)
  maxFullSizeProducts      Int?                       @default(2)
  storesAddedThisMonth     Int                        @default(0)
  lastMonthlyReset         DateTime?
  currentActiveStores      Int                        @default(0)
  transactionFeePercent    Float?                     @default(5.0)
  monthlyPlatformFee       Float?                     @default(0.0)
  approvalStatus           String                     @default("pending")
  approvedAt               DateTime?
  approvedBy               String?
  rejectionReason          String?
  onboardingStep           String                     @default("registration")
  customerServiceEmail     String?
  customerServicePhone     String?
  conversions              conversions[]
  customers                customers[]
  display_packs            display_packs[]
  displays                 displays[]
  orders                   orders[]
  promo_redemptions        promo_redemptions[]
  sample_history           sample_history[]
  shopify_webhook_logs     shopify_webhook_logs[]
  store_brand_partnerships store_brand_partnerships[]
  stores                   stores[]
  users                    users[]
  wholesale_orders         wholesale_orders[]
}

model product_holds {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId    String
  productSku String
  customerId String?
  quantity   Int
  reason     String?
  expiresAt  DateTime?
  releasedAt DateTime?
  createdAt  DateTime  @default(now())
  status     String    @default("active")
  notifiedAt DateTime?
  pickedUpAt DateTime?
  stores     stores    @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model products {
  id                    String                  @id
  sku                   String                  @unique
  orgId                 String
  name                  String
  description           String?
  category              String?
  price                 Decimal                 @db.Decimal(10, 2)
  msrp                  Decimal?                @db.Decimal(10, 2)
  imageUrl              String?
  active                Boolean                 @default(true)
  featured              Boolean                 @default(false)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  productType           String                  @default("retail")
  retailPrice           Decimal?                @db.Decimal(10, 2)
  unitsPerBox           Int?
  wholesalePrice        Decimal?                @db.Decimal(10, 2)
  shopifyProductId      String?
  shopifyVariantId      String?
  purchase_intents      purchase_intents[]
  store_inventory       store_inventory[]
  wholesale_order_items wholesale_order_items[]
}

model promo_redemptions {
  id                String        @id
  customerId        String
  storeId           String
  orgId             String
  promoOffer        String
  promoSlug         String        @unique
  redeemedAt        DateTime?
  redeemedBy        String?
  purchaseAmount    Decimal?      @db.Decimal(10, 2)
  discountAmount    Decimal?      @db.Decimal(10, 2)
  createdAt         DateTime      @default(now())
  redeemedByStaffId String?
  customers         customers     @relation(fields: [customerId], references: [id])
  organizations     organizations @relation(fields: [orgId], references: [orgId])
  stores            stores        @relation(fields: [storeId], references: [id])

  @@index([customerId])
  @@index([orgId])
  @@index([storeId])
}

model purchase_intents {
  id                 String    @id
  customerId         String
  storeId            String
  productSku         String
  originalPrice      Decimal   @db.Decimal(10, 2)
  discountPercent    Int
  finalPrice         Decimal   @db.Decimal(10, 2)
  status             String    @default("pending")
  verifySlug         String    @unique
  fulfilledAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  fulfilledByStaffId String?
  notifiedAt         DateTime?
  customers          customers @relation(fields: [customerId], references: [id])
  staff              staff?    @relation(fields: [fulfilledByStaffId], references: [id])
  products           products  @relation(fields: [productSku], references: [sku])

  @@index([customerId])
  @@index([productSku])
  @@index([storeId])
}

model sample_history {
  id                String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId           String
  customerId        String?
  productSku        String
  displayId         String?
  quantity          Int            @default(1)
  givenAt           DateTime       @default(now())
  givenBy           String?
  notes             String?
  sampledAt         DateTime?      @default(now())
  brandId           String?
  attributionWindow Int?
  expiresAt         DateTime?
  productName       String?
  organizations     organizations? @relation(fields: [brandId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  stores            stores         @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model shopify_webhook_logs {
  id             String        @id
  orgId          String
  webhookId      String?
  topic          String
  shopifyOrderId String?
  payload        Json
  status         String        @default("pending")
  errorMessage   String?
  processedAt    DateTime?
  createdAt      DateTime      @default(now())
  customerId     String?
  customers      customers?    @relation(fields: [customerId], references: [id])
  organizations  organizations @relation(fields: [orgId], references: [orgId])

  @@index([customerId])
  @@index([orgId])
  @@index([shopifyOrderId])
  @@index([status])
}

model shortlinks {
  id          String    @id
  slug        String    @unique
  action      String
  storeId     String
  memberId    String?
  role        String
  requiresPin Boolean   @default(false)
  redeemed    Boolean   @default(false)
  redeemedAt  DateTime?
  createdAt   DateTime  @default(now())
  usedAt      DateTime?
}

model staff {
  id                                                String                     @id
  staffId                                           String                     @unique
  storeId                                           String
  firstName                                         String
  lastName                                          String
  email                                             String?
  phone                                             String
  profilePhoto                                      String?
  type                                              String
  staffPin                                          String
  status                                            String                     @default("active")
  hireDate                                          DateTime                   @default(now())
  onCallDays                                        String[]
  onCallHoursStart                                  String
  onCallHoursStop                                   String
  samplesRedeemed                                   Int                        @default(0)
  salesGenerated                                    Int                        @default(0)
  lastActive                                        DateTime?
  notes                                             String?
  createdAt                                         DateTime                   @default(now())
  updatedAt                                         DateTime
  verificationExpiry                                DateTime?
  verificationToken                                 String?                    @unique
  verified                                          Boolean                    @default(false)
  verifiedAt                                        DateTime?
  totalPoints                                       Int                        @default(0)
  quarterlyPoints                                   Int                        @default(0)
  lastQuarterReset                                  DateTime?
  lastReminderSentAt                                DateTime?
  customers_customers_promoRedeemedByStaffIdTostaff customers[]                @relation("customers_promoRedeemedByStaffIdTostaff")
  customers_customers_redeemedByStaffIdTostaff      customers[]                @relation("customers_redeemedByStaffIdTostaff")
  purchase_intents                                  purchase_intents[]
  stores                                            stores                     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  staff_point_transactions                          staff_point_transactions[]
}

model staff_point_transactions {
  id               String     @id
  staffId          String
  storeId          String
  orgId            String
  points           Decimal    @db.Decimal(10, 2)
  type             String
  reason           String
  customerId       String?
  conversionId     String?
  purchaseIntentId String?
  quarter          String
  createdAt        DateTime   @default(now())
  customers        customers? @relation(fields: [customerId], references: [id])
  staff            staff      @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([quarter])
  @@index([staffId])
  @@index([storeId])
  @@index([type])
}

model store_brand_partnerships {
  id                     String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId                String
  brandId                String
  status                 String        @default("active")
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @default(now())
  availableSamples       String[]      @default([])
  availableProducts      String[]      @default([])
  onlineCommission       Decimal?      @default(20.0) @db.Decimal(5, 2)
  subscriptionCommission Decimal?      @default(5.0) @db.Decimal(5, 2)
  promoCommission        Decimal?      @default(50.0) @db.Decimal(5, 2)
  storeCreditBalance     Decimal?      @default(0) @db.Decimal(10, 2)
  active                 Boolean       @default(true)
  commissionRate         Decimal?      @db.Decimal(5, 2)
  notes                  String?
  partnerSince           DateTime?
  partnershipEndedAt     DateTime?
  organizations          organizations @relation(fields: [brandId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  stores                 stores        @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([storeId, brandId])
}

model store_credit_transactions {
  id                 String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId            String
  type               String
  amount             Decimal  @db.Decimal(10, 2)
  previousBalance    Decimal? @db.Decimal(10, 2)
  newBalance         Decimal? @db.Decimal(10, 2)
  description        String?
  reference          String?
  createdAt          DateTime @default(now())
  brandPartnershipId String?
  stores             stores   @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model store_inventory {
  id                String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId           String
  productSku        String
  quantityOnHand    Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @default(now())
  quantityReserved  Int       @default(0)
  quantityAvailable Int       @default(0)
  lowStockThreshold Int?
  reorderPoint      Int?
  lastRestockedAt   DateTime?
  notes             String?
  quantityIncoming  Int       @default(0)
  products          products  @relation(fields: [productSku], references: [sku], map: "store_inventory_productsku_fkey")
  stores            stores    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, productSku])
}

model stores {
  id                        String                      @id
  storeId                   String                      @unique
  orgId                     String
  status                    String                      @default("active")
  storeName                 String
  adminName                 String?
  adminEmail                String?
  adminPhone                String?
  streetAddress             String?
  city                      String?
  state                     String?
  zipCode                   String?
  timezone                  String                      @default("America/Los_Angeles")
  promoOffer                String                      @default("20%-off 1st Purchase")
  followupDays              Int[]                       @default([4, 12])
  staffPin                  String?
  activatedAt               DateTime?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  ownerEmail                String?
  ownerName                 String?
  ownerPhone                String?
  purchasingEmail           String?
  purchasingManager         String?
  purchasingPhone           String?
  availableSamples          String[]                    @default([])
  setupPhotoCredit          Boolean                     @default(false)
  setupPhotoUploadedAt      DateTime?
  setupPhotoUrl             String?
  availableProducts         String[]                    @default([])
  postPurchaseFollowupDays  Int[]                       @default([45, 90])
  returningCustomerPromo    String                      @default("10%-off In-Store Purchase")
  parentAccountName         String?
  shopifyCustomerId         String?
  platformId                String?
  subscriptionTier          String                      @default("free")
  subscriptionStatus        String                      @default("active")
  rechargeCustomerId        String?
  rechargeSubscriptionId    String?
  nextBillingDate           DateTime?
  trialEndsAt               DateTime?
  customerSlotsGranted      Int                         @default(10)
  samplesPerQuarter         Int                         @default(10)
  commissionRate            Float                       @default(5.0)
  promoReimbursementRate    Float                       @default(10.0)
  salesRepName              String?
  salesRepEmail             String?
  salesRepPhone             String?
  address2                  String?
  storeCredit               Decimal                     @default(0.00) @db.Decimal(10, 2)
  maxBrandPartnerships      Int                         @default(1)
  activeBrandCount          Int                         @default(0)
  messageCreditBalance      Int?                        @default(100)
  totalMessagesSent         Int?                        @default(0)
  lastCreditRefill          DateTime?                   @default(now()) @db.Timestamp(6)
  lastMessageBlastAt        DateTime?                   @db.Timestamp(6)
  conversions               conversions[]
  customers                 customers[]
  displays                  displays[]
  inventory_transactions    inventory_transactions[]
  message_campaigns         message_campaigns[]
  product_holds             product_holds[]
  promo_redemptions         promo_redemptions[]
  sample_history            sample_history[]
  staff                     staff[]
  store_brand_partnerships  store_brand_partnerships[]
  store_credit_transactions store_credit_transactions[]
  store_inventory           store_inventory[]
  organizations             organizations               @relation(fields: [orgId], references: [orgId])
  users                     users[]
  wholesale_orders          wholesale_orders[]
}

model users {
  id            String        @id
  userId        String        @unique
  orgId         String
  email         String        @unique
  name          String?
  role          String
  storeId       String?
  createdAt     DateTime      @default(now())
  phone         String?
  organizations organizations @relation(fields: [orgId], references: [orgId])
  stores        stores?       @relation(fields: [storeId], references: [storeId])
}

model wholesale_order_items {
  id               String           @id @default(dbgenerated("(gen_random_uuid())::text"))
  orderId          String
  productSku       String
  quantity         Int
  unitPrice        Decimal          @db.Decimal(10, 2)
  totalPrice       Decimal          @db.Decimal(10, 2)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @default(now())
  retailUnits      Int?
  wholesale_orders wholesale_orders @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products         products         @relation(fields: [productSku], references: [sku], map: "wholesale_order_items_productsku_fkey")
}

model wholesale_orders {
  id                    String                  @id @default(dbgenerated("(gen_random_uuid())::text"))
  storeId               String
  brandId               String
  orderNumber           String                  @unique
  status                String                  @default("pending")
  totalAmount           Decimal                 @db.Decimal(10, 2)
  shopifyOrderId        String?
  placedAt              DateTime                @default(now())
  fulfilledAt           DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @default(now())
  lastReminderSentAt    DateTime?
  receivedAt            DateTime?
  deliveredAt           DateTime?
  verificationToken     String?
  orderId               String?
  cancelledAt           DateTime?
  creditApplied         Decimal?                @db.Decimal(10, 2)
  notes                 String?
  shopifyDomain         String?
  shopifyDraftOrderId   String?
  shopifyDraftOrderUrl  String?
  shopifyFulfillmentId  String?
  submittedAt           DateTime?
  subtotal              Decimal?                @db.Decimal(10, 2)
  total                 Decimal?                @db.Decimal(10, 2)
  trackingNumber        String?
  verificationNotes     String?
  verifiedBy            String?
  wholesale_order_items wholesale_order_items[]
  organizations         organizations           @relation(fields: [brandId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  stores                stores                  @relation(fields: [storeId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}
